name: CI/CD - DevHub (PROD) â†’ Sandbox

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-package:
    name: Create Package Version (DEBUG MODE)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate DevHub (PROD)
        uses: sfdx-actions/setup-sfdx@v1
        with:
          sfdx-auth-url: ${{ secrets.SFDX_AUTH_URL_PROD }}

      - name: Install Packaging Plugin
        run: |
          sf plugins install @salesforce/plugin-packaging

      - name: Create Package Version (DEBUG - DO NOT STOP ON ERROR)
        id: pkg
        run: |
          echo "Running: sf package version create"

          # run command but DO NOT stop workflow
          sf package version create \
            --package MyApp \
            --path force-app \
            --installation-key "${{ secrets.PACKAGE_KEY }}" \
            --wait 20 \
            --json > pkg.json 2>&1 || true

          echo "===== RAW PACKAGE VERSION OUTPUT ====="
          cat pkg.json || echo "pkg.json missing"
          echo "======================================"

          # try extract version (may be empty)
          if jq -e '.result.SubscriberPackageVersionId' pkg.json >/dev/null 2>&1; then
            v=$(jq -r '.result.SubscriberPackageVersionId' pkg.json)
            echo "pkg_version=$v" >> $GITHUB_OUTPUT
          else
            echo "NO PACKAGE VERSION FOUND"
            echo "pkg_version=" >> $GITHUB_OUTPUT
          fi

  validate-sandbox:
    name: Validate Package in Sandbox (Check-Only)
    runs-on: ubuntu-latest
    needs: build-package

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate Sandbox
        uses: sfdx-actions/setup-sfdx@v1
        with:
          sfdx-auth-url: ${{ secrets.SFDX_AUTH_URL_SANDBOX }}

      - name: Validate in Sandbox (check-only)
        run: |
          sf package install \
            --package ${{ needs.build-package.outputs.pkg_version }} \
            --target-org devhub \
            --check-only \
            --wait 20 \
            --publish-wait 10 \
            --no-prompt

  deploy-sandbox:
    name: Deploy Package to Sandbox
    runs-on: ubuntu-latest
    needs: validate-sandbox

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate Sandbox
        uses: sfdx-actions/setup-sfdx@v1
        with:
          sfdx-auth-url: ${{ secrets.SFDX_AUTH_URL_SANDBOX }}

      - name: Install Package into Sandbox
        run: |
          sf package install \
            --package ${{ needs.build-package.outputs.pkg_version }} \
            --target-org devhub \
            --wait 20 \
            --publish-wait 10 \
            --no-prompt
