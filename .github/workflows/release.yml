name: CI/CD - DevHub (PROD) → Sandbox

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-package:
    name: Create Package Version (DevHub = PROD)
    runs-on: ubuntu-latest
    outputs:
      pkg_version: ${{ steps.create_pkg.outputs.pkg_version }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate DevHub (PROD)
        uses: sfdx-actions/setup-sfdx@v1
        with:
          sfdx-auth-url: ${{ secrets.SFDX_AUTH_URL_PROD }}

      - name: Install Packaging Plugin
        run: |
          sf plugins install @salesforce/plugin-packaging

      - name: Create Package Version (handles optional key or bypass)
        id: create_pkg
        run: |
          # Build either installation key flag or bypass flag
          KEY_FLAG=""
          if [ -n "${{ secrets.PACKAGE_KEY }}" ]; then
            echo "Using installation key from secret (will not print key)"
            KEY_FLAG="--installation-key '${{ secrets.PACKAGE_KEY }}'"
          else
            echo "No PACKAGE_KEY secret found — using installation-key-bypass"
            KEY_FLAG="--installation-key-bypass"
          fi

          echo "Running: sf package version create --package MyApp --path force-app $KEY_FLAG"
          eval "sf package version create --package MyApp --path force-app $KEY_FLAG --wait 20 --json" > pkg.json 2>&1 || true

          echo "===== PACKAGE CREATE RAW OUTPUT ====="
          cat pkg.json || echo "pkg.json missing"
          echo "====================================="

          if jq -e '.result.SubscriberPackageVersionId' pkg.json >/dev/null 2>&1; then
            pkgid=$(jq -r '.result.SubscriberPackageVersionId' pkg.json)
            echo "Found pkg id: $pkgid"
            echo "pkg_version=$pkgid" >> $GITHUB_OUTPUT
          else
            echo "ERROR: No package version id found in pkg.json"
            echo "pkg_version=" >> $GITHUB_OUTPUT
            exit 1
          fi

  validate-sandbox:
    name: Validate Package in Sandbox (Check-Only)
    runs-on: ubuntu-latest
    needs: build-package

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate Sandbox
        uses: sfdx-actions/setup-sfdx@v1
        with:
          sfdx-auth-url: ${{ secrets.SFDX_AUTH_URL_SANDBOX }}

      - name: Validate in Sandbox (check-only)
        run: |
          echo "Validating package_version: ${{ needs.build-package.outputs.pkg_version }}"
          sf package version install \
            --package "${{ needs.build-package.outputs.pkg_version }}" \
            --target-org devhub \
            --check-only \
            --no-prompt \
            --wait 20 \
            --publish-wait 10

  deploy-sandbox:
    name: Deploy Package to Sandbox
    runs-on: ubuntu-latest
    needs: validate-sandbox

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate Sandbox
        uses: sfdx-actions/setup-sfdx@v1
        with:
          sfdx-auth-url: ${{ secrets.SFDX_AUTH_URL_SANDBOX }}

      - name: Install Package into Sandbox
        run: |
          echo "Installing package_version: ${{ needs.build-package.outputs.pkg_version }}"
          sf package version install \
            --package "${{ needs.build-package.outputs.pkg_version }}" \
            --target-org devhub \
            --no-prompt \
            --wait 20 \
            --publish-wait 10
