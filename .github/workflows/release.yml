name: CI/CD (DevHub Prod â†’ Sandbox)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-package:
    name: Create Package Version (DevHub = PROD)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate DevHub (PROD)
        uses: sfdx-actions/setup-sfdx@v1
        with:
          sfdx-auth-url: ${{ secrets.SFDX_AUTH_URL_PROD }}

      - name: Create Package Version
        id: pkg
        run: |
          # Replace MyApp with your package name
          sfdx force:package:version:create -p MyApp -d force-app -k "${{ secrets.PACKAGE_KEY }}" --wait 20 --json > pkg.json
          cat pkg.json
          echo "pkg_version=$(jq -r '.result.SubscriberPackageVersionId' pkg.json)" >> $GITHUB_OUTPUT

  validate-sandbox:
    name: Validate Package in Sandbox
    runs-on: ubuntu-latest
    needs: build-package
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate Sandbox
        uses: sfdx-actions/setup-sfdx@v1
        with:
          sfdx-auth-url: ${{ secrets.SFDX_AUTH_URL_SANDBOX }}

      - name: Validate in Sandbox (check only)
        run: |
          sfdx force:package:install --package ${{ needs.build-package.outputs.pkg_version }} -u devhub --checkonly --wait 20 --publishwait 10 --noprompt

  deploy-sandbox:
    name: Deploy Package to Sandbox
    runs-on: ubuntu-latest
    needs: validate-sandbox
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate Sandbox
        uses: sfdx-actions/setup-sfdx@v1
        with:
          sfdx-auth-url: ${{ secrets.SFDX_AUTH_URL_SANDBOX }}

      - name: Install Package into Sandbox
        run: |
          sfdx force:package:install --package ${{ needs.build-package.outputs.pkg_version }} -u devhub --wait 20 --publishwait 10 --noprompt
